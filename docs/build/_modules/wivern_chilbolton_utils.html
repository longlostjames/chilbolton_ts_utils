<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wivern_chilbolton_utils &mdash; wivern2_chilbolton 1.0.0 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link href="../_static/custom.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> wivern2_chilbolton
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fileformat.html">Filename conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fileformat.html#file-format-description">File format description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide.html">Developerâ€™s Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">wivern2_chilbolton</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>wivern_chilbolton_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wivern_chilbolton_utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># coding: utf-8</span>

<span class="c1"># ==========================================================================</span>
<span class="c1"># Module for processing raw radar data from CAMRa (3GHz), Copernicus (35GHz)</span>
<span class="c1"># and Galileo (94GHz) radars at Chilbolton, collected as part of the</span>
<span class="c1"># ESA WIVERN-2 project in 2020-2021.</span>
<span class="c1"># Author: Chris Walden, UK Research &amp; Innovation and</span>
<span class="c1">#                       National Centre for Atmospheric Science</span>
<span class="c1"># Last modified: 03-04-2022</span>
<span class="c1"># ==========================================================================</span>

<span class="sd">&quot;&quot;&quot;Module for processing raw radar data from CAMRa (3GHz), Copernicus (35GHz)</span>
<span class="sd">and Galieo (94GHz) radars at Chilbolton, collected as part of the</span>
<span class="sd">ESA WIVERN-2 project in 2020-2021.&quot;&quot;&quot;</span>

<span class="n">module_version</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">import</span> <span class="nn">fnmatch</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>

<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc4</span>
<span class="kn">import</span> <span class="nn">cftime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">tzinfo</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>

<span class="kn">import</span> <span class="nn">pyart</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">import</span> <span class="nn">cmocean</span>




<span class="c1"># ===================</span>
<span class="c1"># CONVERSION ROUTINES</span>
<span class="c1"># ===================</span>

<div class="viewcode-block" id="convert_camra_ts_l0a2l0b"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.convert_camra_ts_l0a2l0b">[docs]</a><span class="k">def</span> <span class="nf">convert_camra_ts_l0a2l0b</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">outfile</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine converts raw (Level 0a) time series data from the Chilbolton Advanced Meteorological Radar (CAMRa) to Level 0b data.</span>
<span class="sd">    Processing involves removing redundant dimensions, and removing bias from the ADC samples of transmit and receive I and Q.</span>
<span class="sd">    Single estimates of I and Q for each transmit pulse are produced and stored in the output file.</span>
<span class="sd">    Metadata are added specific to the WIVERN-2 project ground-based observations collected in 2020-2021.</span>

<span class="sd">    :param infile: Full path of NetCDF Level 0a raw data file, e.g. `&lt;path-to-file&gt;/radar-camra_20201210212823_fix-ts.nc`</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param outfile: Full path of NetCDF Level 0b output file, e.g. `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l0b_v1.0.nc`</span>
<span class="sd">    :type outfile: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DSin</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">);</span>

    <span class="n">dt_start</span> <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">num2pydate</span><span class="p">(</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    <span class="n">dt_end</span>   <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">num2pydate</span><span class="p">(</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span> <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># just to be safe, make sure dataset is not already open.</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="n">DSout</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">));</span>

    <span class="c1"># ------------------------</span>
    <span class="c1"># Set up global attributes</span>
    <span class="c1"># ------------------------</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">product_version</span> <span class="o">=</span> <span class="s2">&quot;v1.0&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_level</span> <span class="o">=</span> <span class="s2">&quot;0b&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">licence</span> <span class="o">=</span> <span class="s2">&quot;This dataset is released for use under a Creative Commons Attribution 4.0 International (CC-BY 4.0) license (see https://creativecommons.org/licenses/by/4.0/ for terms and conditions).&quot;</span>
<span class="c1">#    DSout.licence = &quot;Data usage licence - UK Open Government Licence agreement: \n http://www.nationalarchives.gov.uk/doc/open-government-licence&quot; ;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">acknowledgement</span> <span class="o">=</span> <span class="s2">&quot;This dataset was developed as part of the activity </span><span class="se">\&quot;</span><span class="s2">Doppler Wind Radar Science Performance Study (WIVERN-2)</span><span class="se">\&quot;</span><span class="s2">, funded by the European Space Agency under Contract no. 4000130864/20/NL/CT.  Users should acknowledge UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science).&quot;</span> <span class="p">;</span>
<span class="c1">#    DSout.acknowledgement = &quot;Acknowledgement is required of UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science) whenever and wherever these data are used.&quot; ;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;Chilbolton Atmospheric Observatory&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">platform_type</span> <span class="o">=</span> <span class="s2">&quot;stationary_platform&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Time series from 3 GHz CAMRa radar collected for ESA WIVERN-2 campaign at Chilbolton Observatory&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_name</span> <span class="o">=</span> <span class="s2">&quot;Chris Walden&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_email</span> <span class="o">=</span> <span class="s2">&quot;chris.walden@ncas.ac.uk&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_url</span> <span class="o">=</span> <span class="s2">&quot;https://orcid.org/0000-0002-5718-466X&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">institution</span> <span class="o">=</span> <span class="s2">&quot;National Centre for Atmospheric Science (NCAS)&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_name</span> <span class="o">=</span> <span class="s2">&quot;ncas-radar-camra-1&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_software</span> <span class="o">=</span> <span class="s2">&quot;radar-camra-rec&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_software_version</span> <span class="o">=</span> <span class="s2">&quot;1.4 Rev 58&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">references</span> <span class="o">=</span> <span class="s2">&quot;https://doi.org/10.1049/ecej:19940205; http://purl.org/net/epubs/work/63318; https://doi.org/10.1109/IGARSS.2006.429; https://doi.org/10.3390/atmos10110714&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;3GHz Chilbolton Advanced Meteorological Radar (CAMRa)&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="s2">&quot;WIVERN-2 Doppler Wind Radar Science Performance Study&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator</span> <span class="o">=</span> <span class="s2">&quot;Anthony Illingworth&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator_email</span> <span class="o">=</span> <span class="s2">&quot;a.j.illingworth@reading.ac.uk&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator_url</span> <span class="o">=</span> <span class="s2">&quot;https://orcid.org/0000-0002-5774-8410&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_software_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/longlostjames/wivern_chilbolton_utils.git&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_software_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">scantype</span> <span class="o">=</span> <span class="s2">&quot;vertical_pointing&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">time_coverage_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_start</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">time_coverage_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_end</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">geospatial_bounds</span> <span class="o">=</span> <span class="s2">&quot;51.1450N -1.4384E&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">pulse_compression</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">ADC_bits_per_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">DSin</span><span class="o">.</span><span class="n">ADC_bits_per_sample</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">ADC_channels</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">DSin</span><span class="o">.</span><span class="n">ADC_channels</span><span class="p">);</span>

    <span class="c1"># ----------------</span>
    <span class="c1"># Scalar variables</span>
    <span class="c1"># ----------------</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude of the antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree_north&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">51.1450</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude of the antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree_east&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=-</span><span class="mf">1.4384</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;altitude&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude of the elevation axis above the geoid (WGS84)&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">146.7</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;altitude_agl&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude of the elevation axis above ground&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">16.0</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;radiation_frequency&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;frequency of transmitted radiation&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;GHz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;prf&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pulse repetition frequency&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;beamwidthH&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;beamwidthH&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;horizontal angular beamwidth&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;beamwidthV&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;beamwidthV&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;vertical angular beamwidth&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;antenna_diameter&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_diameter&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;antenna diameter&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_focal_length&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;focal length of antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">9.0</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_focus_radial_location&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;distance along boresight from elevation axis to antenna focus&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">14.34</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;pulse_period&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulse_width&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pulse width&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;us&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;transmit_power&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;transmit_power&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;peak transmitted power&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;clock&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;clock&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock input to timer card&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;clock_divfactor&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock divide factor&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;clock&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clock_divfactor</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;delay_clocks&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock cycles before sampling is initiated&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">delay_clocks</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;samples_per_pulse&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of samples per pulse&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">samples_per_pulse</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulses_per_daq_cycle&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of pulses per data acquisition cycle&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">pulses_per_daq_cycle</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulses_per_ray&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of pulses per ray&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">pulses_per_ray</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;radar_constant&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;radar constant&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">radar_constant</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;receiver_gain&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;receiver gain&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">receiver_gain</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;cable_losses&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cable losses&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">cable_losses</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;extra_attenuation&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;extra attenuation&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">DSin</span><span class="o">.</span><span class="n">extra_attenuation</span><span class="p">;</span>


    <span class="c1"># ---------------</span>
    <span class="c1"># Copy dimensions</span>
    <span class="c1"># ---------------</span>
    <span class="n">the_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">];</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_dim</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">the_dim</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">the_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;pulses&#39;</span><span class="p">];</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_dim</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">the_dim</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">the_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">];</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_dim</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">the_dim</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Coordinate variables</span>
    <span class="c1"># --------------------</span>
    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;time at the end of each recorded ray&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">varin</span><span class="o">.</span><span class="n">units</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;range&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">varin</span><span class="o">.</span><span class="n">long_name</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">range_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">varin</span><span class="o">.</span><span class="n">range_offset</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">varin</span><span class="o">.</span><span class="n">units</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Antenna pointing variables</span>
    <span class="c1"># --------------------------</span>
    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;elevation angle of the antenna boresight above the horizon&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">elevation_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;azimuth angle of the antenna boresight clockwise from the grid north&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;More generally this is the azimuth angle of the plane perpendicular to the elevation axis, which remains defined even when the elevation is 90 degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">azimuth_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>

    <span class="c1"># ---------------</span>
    <span class="c1"># Field variables</span>
    <span class="c1"># ---------------</span>
    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZLO&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ZLO&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;ZLO log amplifier output (channel with +12dB gain)&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>
    <span class="n">comment_string</span>  <span class="o">=</span> <span class="s2">&quot;This is an estimator for co-polar radar equivalent reflectivity factor.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">comment_string</span> <span class="o">+=</span> <span class="s2">&quot;It does not take into account range correction, the radar constant, receiver gain or cable losses.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">comment_string</span> <span class="o">+=</span> <span class="s2">&quot;The data are packed and only values in the range [0,3840] (equivalent to the actual_range when the data are unpacked) should be used.&quot;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_string</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.015625</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">add_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">70.</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">70.</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">10.</span><span class="p">)];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZHI&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ZHI&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;ZHI log amplifier output (channel with -20dB attenuation)&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>
    <span class="n">comment_string</span>  <span class="o">=</span> <span class="s2">&quot;This is an estimator for co-polar radar equivalent reflectivity factor.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">comment_string</span> <span class="o">+=</span> <span class="s2">&quot;It does not take into account range correction, the radar constant, receiver gain or cable losses.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">comment_string</span> <span class="o">+=</span> <span class="s2">&quot;The data are packed and only values in the range [1793,4095] (equivalent to the actual_range when the data are unpacked) should be used.&quot;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_string</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.015625</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">add_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">38.</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">9.984375</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">25.984375</span><span class="p">)];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZCX&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ZCX&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cross-polar log amplifier output&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>
    <span class="n">comment_string</span>  <span class="o">=</span> <span class="s2">&quot;This is an estimator for cross-polar radar equivalent reflectivity factor.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">comment_string</span> <span class="o">+=</span> <span class="s2">&quot;It does not take into account range correction, the radar constant, receiver gain or cable losses.&quot;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_string</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.03125</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">add_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="o">-</span><span class="mf">77.</span><span class="p">);</span>

    <span class="c1"># -------------------------------------------------------</span>
    <span class="c1"># Determine bias-corrected I and Q of each transmit pulse</span>
    <span class="c1"># -------------------------------------------------------</span>
    <span class="n">delay_clocks</span> <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;delay_clocks&#39;</span><span class="p">][:];</span>
    <span class="n">clock_divfactor</span> <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;clock_divfactor&#39;</span><span class="p">][:];</span>

    <span class="n">pre_tx</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">18</span>   <span class="o">-</span> <span class="n">delay_clocks</span><span class="p">)</span> <span class="o">//</span> <span class="n">clock_divfactor</span><span class="p">;</span>
    <span class="n">tx_pulse</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">24</span>   <span class="o">-</span> <span class="n">delay_clocks</span><span class="p">)</span> <span class="o">//</span> <span class="n">clock_divfactor</span><span class="p">;</span>
    <span class="n">post_tx</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">68</span>   <span class="o">-</span> <span class="n">delay_clocks</span><span class="p">)</span> <span class="o">//</span> <span class="n">clock_divfactor</span><span class="p">;</span>
    <span class="n">hold_end</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">4708</span> <span class="o">-</span> <span class="n">delay_clocks</span><span class="p">)</span> <span class="o">//</span> <span class="n">clock_divfactor</span><span class="p">;</span>
    <span class="n">post_hold</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4748</span> <span class="o">-</span> <span class="n">delay_clocks</span><span class="p">)</span> <span class="o">//</span> <span class="n">clock_divfactor</span><span class="p">;</span>

    <span class="n">ITXin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ITX&#39;</span><span class="p">][:,:,:];</span>
    <span class="n">QTXin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QTX&#39;</span><span class="p">][:,:,:];</span>

    <span class="n">ITX_bias_by_gate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ITXin</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">QTX_bias_by_gate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">QTXin</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">ITXnew</span> <span class="o">=</span> <span class="n">ITXin</span> <span class="o">-</span> <span class="n">ITX_bias_by_gate</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>
    <span class="n">QTXnew</span> <span class="o">=</span> <span class="n">QTXin</span> <span class="o">-</span> <span class="n">QTX_bias_by_gate</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>

    <span class="c1"># Only use data while sample and hold is active</span>
    <span class="c1"># ---------------------------------------------</span>
    <span class="n">sample_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">hold_end</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">])]);</span>

    <span class="n">ITXout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ITXnew</span><span class="p">[:,:,</span><span class="n">post_tx</span><span class="p">:</span><span class="n">sample_end</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">QTXout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">QTXnew</span><span class="p">[:,:,</span><span class="n">post_tx</span><span class="p">:</span><span class="n">sample_end</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ITX&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="c1">#    add_offset = np.min(ITXout[:]);</span>
<span class="c1">#    scale_factor = (np.max(ITXout[:])-np.min(ITXout[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((ITXout[:,:] - add_offset)/scale_factor));</span>
<span class="c1">#    varout.scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    varout.add_offset = np.float32(add_offset);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;bias-corrected samples of in-phase video signal for each transmitted pulse&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
<span class="c1">#    varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">ITXout</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;QTX&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="c1">#    add_offset = np.min(QTXout[:]);</span>
<span class="c1">#    scale_factor = (np.max(QTXout[:])-np.min(QTXout[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((QTXout[:,:] - add_offset)/scale_factor));</span>
<span class="c1">#    varout.scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    varout.add_offset = np.float32(add_offset);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;bias-corrected samples of quadrature video signal for each transmitted pulse&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
<span class="c1">#    varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">QTXout</span><span class="p">;</span>

    <span class="c1"># ----------------------------------------</span>
    <span class="c1"># Determine bias-corrected receive I and Q</span>
    <span class="c1"># ----------------------------------------</span>
    <span class="n">IRXin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;IRX&#39;</span><span class="p">][:,:,:];</span>
    <span class="n">QRXin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QRX&#39;</span><span class="p">][:,:,:];</span>
    <span class="n">IRX_bias_by_gate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">IRXin</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">QRX_bias_by_gate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">QRXin</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">IRXout</span> <span class="o">=</span> <span class="n">IRXin</span> <span class="o">-</span> <span class="n">IRX_bias_by_gate</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>
    <span class="n">QRXout</span> <span class="o">=</span> <span class="n">QRXin</span> <span class="o">-</span> <span class="n">QRX_bias_by_gate</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;IRX&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="c1">#    add_offset = np.min(IRXout[:]);</span>
<span class="c1">#    scale_factor = (np.max(IRXout[:])-np.min(IRXout[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((IRXout[:,:,:] - add_offset)/scale_factor));</span>
<span class="c1">#    varout.scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    varout.add_offset = np.float32(add_offset);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;bias-corrected samples of received in-phase video signal at output of IF limiting amplifier&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
<span class="c1">#    varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">IRXout</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QRX&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;QRX&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="c1">#    add_offset = np.min(QRXout[:]);</span>
<span class="c1">#    scale_factor = (np.max(QRXout[:])-np.min(QRXout[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((QRXout[:,:,:] - add_offset)/scale_factor));</span>
<span class="c1">#    varout.scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    varout.add_offset = np.float32(add_offset);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;bias-corrected samples of received quadrature video signal at output of IF limiting amplifier&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
<span class="c1">#    varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">QRXout</span><span class="p">;</span>

    <span class="c1"># -----------------------</span>
    <span class="c1"># Update history metadata</span>
    <span class="c1"># -----------------------</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py convert_camra_ts_l0a2l0b&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DSin</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DSin</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="update_licensing"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.update_licensing">[docs]</a><span class="k">def</span> <span class="nf">update_licensing</span><span class="p">(</span><span class="n">l1file</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine updates the licence to Creative Commons Attribution 4.0 International (CC-BY 4.0).</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">licence</span> <span class="o">=</span> <span class="s2">&quot;This dataset is released for use under a Creative Commons Attribution 4.0 International (CC-BY 4.0) license (see https://creativecommons.org/licenses/by/4.0/ for terms and conditions).&quot;</span>
    <span class="n">DS</span><span class="o">.</span><span class="n">acknowledgement</span> <span class="o">=</span> <span class="s2">&quot;This dataset was developed as part of the activity </span><span class="se">\&quot;</span><span class="s2">Doppler Wind Radar Science Performance Study (WIVERN-2)</span><span class="se">\&quot;</span><span class="s2">, funded by the European Space Agency under Contract no. 4000130864/20/NL/CT.  Users should acknowledge UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science).&quot;</span> <span class="p">;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py update_licensing.py&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>

<div class="viewcode-block" id="update_copernicus_azimuth_attributes"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.update_copernicus_azimuth_attributes">[docs]</a><span class="k">def</span> <span class="nf">update_copernicus_azimuth_attributes</span><span class="p">(</span><span class="n">l1file</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine updates the attributes of the azimuth for 35GHz Copernicus radar data.</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-ka-band-1_cao_20201210-21282323_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;azimuth angle from grid north of the plane containing the antenna boresight and zenith vectors&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py update_copernicus_azimuth_attributes.py&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>

<div class="viewcode-block" id="update_galileo_pointing_attributes"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.update_galileo_pointing_attributes">[docs]</a><span class="k">def</span> <span class="nf">update_galileo_pointing_attributes</span><span class="p">(</span><span class="n">l1file</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine updates the attributes of the elevation and azimuth for 94GHz Galileo radar data.</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-w-band-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span>   <span class="o">=</span> <span class="s2">&quot;azimuth angle from grid north of the plane containing the antenna boresight and zenith vectors&quot;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">comment</span>     <span class="o">=</span> <span class="s2">&quot;assumes transmit and receive antenna boresights are aligned&quot;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;elevation angle above the horizon of the antenna boresight&quot;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">comment</span>   <span class="o">=</span> <span class="s2">&quot;assumes transmit and receive antenna boresights are aligned&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py update_galileo_pointing_attributes.py&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>

<div class="viewcode-block" id="encode_antenna_mispointing"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.encode_antenna_mispointing">[docs]</a><span class="k">def</span> <span class="nf">encode_antenna_mispointing</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">elevation_offset</span><span class="p">,</span><span class="n">azimuth</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine updates the elevation and azimuth to account for antenna mispointing.</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-w-band-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param elevation_offset: angle between boresight and zenith in degrees.</span>
<span class="sd">    :type elevation_offset: float</span>

<span class="sd">    :param azimuth: azimuth angle from grid north of the plane containing the antenna boresight and zenith vectors</span>
<span class="sd">    :type azimuth: float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Azimuths are specifed to the nearest cardinal, primary or secondary intercardinal compass bearing (i.e. N, NE, NNE etc.). Values are derived from analysis by John Nicol (john@weatherradar.co.nz) of Doppler returns from thin ice at the tops of clouds that have negligible velocity, and measuring the apparent velocity induced by strong winds that change direction over a period of several hours. The speed and direction of the winds at the appropriate height are taken from ECMWF (European Centre for Medium-Range Weather Forecasts) model data.&quot;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">elevation_offset</span><span class="p">;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Antenna mispointing results in elevations below 90 degrees. Values are derived from analysis by John Nicol (john@weatherradar.co.nz) of Doppler returns from thin ice at the tops of clouds that have negligible velocity, and measuring the apparent velocity induced by strong winds that change direction over a period of several hours. The speed and direction of the winds at the appropriate height are taken from ECMWF (European Centre for Medium-Range Weather Forecasts) model data.&quot;</span>


    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py encode_antenna_mispointing.py&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>


<div class="viewcode-block" id="encode_dBZ_offset"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.encode_dBZ_offset">[docs]</a><span class="k">def</span> <span class="nf">encode_dBZ_offset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">dBZ_offset</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine creates a dBZ_offset variable to store the offset.  It assumes this offset has already been applied.  Note: the routine assumes an additional offset of 10log10(PRF/512) will be added, so this should not be included when caling this function.</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-w-band-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param dBZ_offset: value of dBZ offset already applied.</span>
<span class="sd">    :type elevation_offset: float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;dBZ_offset&#39;</span> <span class="ow">in</span> <span class="n">DS</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">varout</span> <span class="o">=</span> <span class="n">DS</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;dBZ_offset&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
        <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;dBZ offset applied&#39;</span><span class="p">;</span>
        <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;When converted to linear units this is included in the linear reflectivity factor.  The square root of the latter is used to scale the I and Q values.&#39;</span><span class="p">;</span>

        <span class="n">Zcal</span><span class="o">=</span><span class="n">dBZ_offset</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DS</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][:]</span><span class="o">/</span><span class="mi">512</span><span class="p">);</span>
        <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Zcal</span><span class="p">;</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

        <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

        <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
                                 <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
                                 <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py encode_dBZ_offset.py&quot;</span>
                                 <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

        <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

        <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dBZ_offset variable already exists&#39;</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>


<div class="viewcode-block" id="adjust_range_offset"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.adjust_range_offset">[docs]</a><span class="k">def</span> <span class="nf">adjust_range_offset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">delta_range</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine updates the range offset</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type l1file: str</span>

<span class="sd">    :param delta_range: increment to be added to range in metres</span>
<span class="sd">    :type delta_range: float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][:]</span> <span class="o">+=</span> <span class="n">delta_range</span><span class="p">;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">range_offset_applied</span> <span class="o">+=</span> <span class="n">delta_range</span><span class="p">;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py adjust_range_offset&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>

<div class="viewcode-block" id="flag_bad_ray"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.flag_bad_ray">[docs]</a><span class="k">def</span> <span class="nf">flag_bad_ray</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">ray</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine flags individual rays as bad data</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type l1file: str</span>

<span class="sd">    :param ray: index of ray to be flagged</span>
<span class="sd">    :type ray: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">][</span><span class="n">ray</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py flag_bad_ray </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>

<div class="viewcode-block" id="correct_flagged_ray"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.correct_flagged_ray">[docs]</a><span class="k">def</span> <span class="nf">correct_flagged_ray</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">ray</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine corrects a ray erroneously flagged as bad data</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type l1file: str</span>

<span class="sd">    :param ray: index of ray to have flag corrected</span>
<span class="sd">    :type ray: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">][</span><span class="n">ray</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">blind_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">][</span><span class="n">ray</span><span class="p">,:,</span><span class="n">blind_range</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py correct_flagged_ray </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ray</span><span class="p">)</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>

<div class="viewcode-block" id="update_copernicus_location"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.update_copernicus_location">[docs]</a><span class="k">def</span> <span class="nf">update_copernicus_location</span><span class="p">(</span><span class="n">l1file</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine updates the latitude, longitude and altitude for the Copernicus radar</span>

<span class="sd">    :param l1file: Full path of NetCDF Level 1 file, `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------------------------</span>
    <span class="c1"># Open NetCDF file for update</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">l1file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">geospatial_bounds</span> <span class="o">=</span> <span class="s2">&quot;51.1447N -1.4384E&quot;</span><span class="p">;</span>

    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">51.1447</span><span class="p">;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.4384</span><span class="p">;</span>
    <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">130.7</span> <span class="o">+</span> <span class="n">DS</span><span class="p">[</span><span class="s1">&#39;altitude_agl&#39;</span><span class="p">][:];</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py update_copernicus_location&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DS</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DS</span><span class="o">.</span><span class="n">close</span><span class="p">();</span></div>



<div class="viewcode-block" id="convert_camra_ts_l0b2l1"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.convert_camra_ts_l0b2l1">[docs]</a><span class="k">def</span> <span class="nf">convert_camra_ts_l0b2l1</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">outfile</span><span class="p">,</span><span class="n">dBZh_offset</span><span class="p">,</span><span class="n">ZDR_offset</span><span class="p">,</span><span class="n">range_offset</span><span class="p">,</span><span class="n">version</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine converts Level 0b time series data from the Chilbolton Advanced Meteorological Radar (CAMRa) to Level 1 data.</span>

<span class="sd">    Processing is applied to produce I and Q time series for received data at each range gate.</span>
<span class="sd">    I and Q values from the limiting amplifiers in the receiver are compared with transmit I and Q for each pulse.</span>
<span class="sd">    These are then scaled to the unit circle and multiplied the square root of the sampled linear reflectivity.</span>
<span class="sd">    Processing includes separate calibration offsets for even (H-polarized) and odd (V-polarized) pulses.</span>
<span class="sd">    Metadata are added specific to the WIVERN-2 project ground-based observations collected in 2020-2021.</span>

<span class="sd">    :param infile: Full path of NetCDF Level 0b input file, e.g. `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l0b_v1.0.nc`</span>
<span class="sd">    :type infile: str</span>
<span class="sd">    :param outfile: Full path of NetCDF Level 1 output file, e.g. `&lt;path-to-file&gt;/ncas-radar-camra-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type outfile: str</span>
<span class="sd">    :param dBZh_offset: Calibration offset to be applied to H polarized reflectivity factor</span>
<span class="sd">    :type dBZh_offset: float</span>
<span class="sd">    :param ZDR_offset: Calibration offset that would be applied to differential reflectivity (used to calculate the calibration offset to apply to V polarized reflectivity factor)</span>
<span class="sd">    :type ZDR_offset: float</span>
<span class="sd">    :param range_offset: Additional range offset in metres to be applied</span>
<span class="sd">    :type range_offset: float</span>
<span class="sd">    :param version: Version of data product in the format `N.m`, where `N` denotes the major verion and `m` a minor revision.</span>
<span class="sd">    :type version: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">toexclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ZLO&#39;</span><span class="p">,</span> <span class="s1">&#39;ZHI&#39;</span><span class="p">,</span> <span class="s1">&#39;ZCX&#39;</span><span class="p">,</span> <span class="s1">&#39;ITX&#39;</span><span class="p">,</span> <span class="s1">&#39;QTX&#39;</span><span class="p">,</span> <span class="s1">&#39;IRX&#39;</span><span class="p">,</span> <span class="s1">&#39;QRX&#39;</span><span class="p">];</span>

    <span class="k">with</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">,</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>

        <span class="c1"># copy global attributes all at once via dictionary</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">setncatts</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="c1"># copy dimensions</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">dimensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimension</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dimension</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># copy all file data except for the excluded</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toexclude</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
                <span class="c1"># copy variable attributes all at once via dictionary</span>
                <span class="n">dst</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">setncatts</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

                <span class="n">dst</span><span class="p">[</span><span class="n">name</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">name</span><span class="p">][:]</span>


    <span class="k">try</span><span class="p">:</span> <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># just to be safe, make sure dataset is not already open.</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="n">DSout</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="n">DSin</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">);</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">num2pydate</span><span class="p">(</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][:],</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">);</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">product_version</span> <span class="o">=</span> <span class="s2">&quot;v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_level</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Calibrated time series from 3 GHz CAMRa radar collected for ESA WIVERN-2 campaign at Chilbolton Observatory&quot;</span><span class="p">;</span>

    <span class="n">comment_string</span> <span class="o">=</span> <span class="s2">&quot;Correction to account for inverse square power loss with range has not been applied&quot;</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DSin</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">DSout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">comment</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span> <span class="o">+</span> <span class="n">comment_string</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DSout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">comment_string</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;dBZ_offsets_applied&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;pulse&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;dBZ calibration offsets applied for even and odd pulses&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;dBZ offsets for even pulses (H-polarized) and odd pulses (V-polarized)&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;co-polar in-phase video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Values are derived from I/Q on unit circle multiplied by square root of linear reflectivity factor&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;co-polar quadrature video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Values are derived from I/Q on unit circle multiplied by square root of linear reflectivity factor&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ZCX&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cross-polar radar equivalent reflectivity factor&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dBZ&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">,</span><span class="s1">&#39;u1&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">is_quality</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">qualified_variables</span> <span class="o">=</span> <span class="s1">&#39;I Q ZCX&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Quality control flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">flag_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">flag_meanings</span> <span class="o">=</span> <span class="s1">&#39;not_used good_data probably_good_data bad_data data_in_blind_range no_qc_performed&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="n">cable_losses</span> <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;cable_losses&#39;</span><span class="p">][:];</span>
    <span class="n">radar_const</span>  <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;radar_constant&#39;</span><span class="p">][:];</span>
    <span class="n">rec_gain</span>     <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;receiver_gain&#39;</span><span class="p">][:];</span>
    <span class="n">freq</span>         <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">][:];</span>
    <span class="n">prf</span>          <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][:];</span>

    <span class="n">dBZv_offset</span> <span class="o">=</span> <span class="n">dBZh_offset</span><span class="o">-</span><span class="n">ZDR_offset</span><span class="p">;</span>

    <span class="n">dBZcal</span> <span class="o">=</span> <span class="n">radar_const</span><span class="o">-</span><span class="n">rec_gain</span><span class="o">+</span><span class="n">cable_losses</span><span class="p">;</span>

    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;dBZ_offsets_applied&#39;</span><span class="p">][::</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dBZh_offset</span><span class="p">;</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;dBZ_offsets_applied&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dBZv_offset</span><span class="p">;</span>

    <span class="n">Zh_cal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">dBZcal</span><span class="o">+</span><span class="n">dBZh_offset</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">Zv_cal</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">dBZcal</span><span class="o">+</span><span class="n">dBZv_offset</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>

    <span class="n">range_m</span>  <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][:];</span>
    <span class="n">range_km</span> <span class="o">=</span> <span class="p">(</span><span class="n">range_m</span><span class="o">+</span><span class="n">range_offset</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.</span><span class="p">;</span> <span class="c1"># range in km</span>

    <span class="n">ITX</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ITX&#39;</span><span class="p">][:,:];</span> <span class="c1">#*DSin[&#39;ITX&#39;].scale_factor+DSin[&#39;ITX&#39;].add_offset;</span>
    <span class="n">QTX</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QTX&#39;</span><span class="p">][:,:];</span> <span class="c1">#*DSin[&#39;QTX&#39;].scale_factor+DSin[&#39;QTX&#39;].add_offset;</span>
    <span class="n">IRX</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;IRX&#39;</span><span class="p">][:,:,:];</span> <span class="c1">#*DSin[&#39;IRX&#39;].scale_factor+DSin[&#39;IRX&#39;].add_offset;</span>
    <span class="n">QRX</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QRX&#39;</span><span class="p">][:,:,:];</span> <span class="c1">#*DSin[&#39;QRX&#39;].scale_factor+DSin[&#39;QRX&#39;].add_offset;</span>

    <span class="n">Vtx</span> <span class="o">=</span> <span class="n">ITX</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">QTX</span><span class="p">;</span>
    <span class="n">Vrx</span> <span class="o">=</span> <span class="n">IRX</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">QRX</span><span class="p">;</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Vrx</span><span class="p">[:,:,:],</span> <span class="n">Vtx</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]);</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">V</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">V</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">V</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">V</span><span class="p">));</span>

    <span class="n">V</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*-</span><span class="mf">1.</span><span class="p">;</span>

    <span class="n">ZLO</span>  <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZLO&#39;</span><span class="p">][:,:,:];</span>
    <span class="n">ZHI</span>  <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZHI&#39;</span><span class="p">][:,:,:];</span>

    <span class="n">threshold</span>          <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZLO&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">actual_range</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="n">ZED</span>                <span class="o">=</span> <span class="n">ZLO</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">ZED</span><span class="p">[</span><span class="n">ZLO</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZHI</span><span class="p">[</span><span class="n">ZLO</span><span class="o">&gt;</span><span class="n">threshold</span><span class="p">];</span>

    <span class="c1"># Convert to linear ZED</span>
    <span class="n">ZED</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">ZED</span><span class="o">/</span><span class="mf">10.</span><span class="p">);</span>

    <span class="n">ZED</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ZED</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*</span><span class="n">Zh_cal</span><span class="p">;</span>
    <span class="n">ZED</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ZED</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span><span class="o">*</span><span class="n">Zv_cal</span><span class="p">;</span>

    <span class="n">ZCX</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;ZCX&#39;</span><span class="p">][:,:,:];</span>
    <span class="n">ZCX</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ZCX</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">dBZcal</span> <span class="o">+</span> <span class="n">dBZh_offset</span><span class="p">;</span>
    <span class="n">ZCX</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ZCX</span><span class="p">[:,</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">dBZcal</span> <span class="o">+</span> <span class="n">dBZv_offset</span><span class="p">;</span>
 <span class="c1">#   add_offset = np.min(ZCX[:]);</span>
 <span class="c1">#   scale_factor = (np.max(ZCX[:])-np.min(ZCX[:])) / (2**16-1)</span>
 <span class="c1">#   packed_data = np.int16(np.rint((ZCX[:,:,:] - add_offset)/scale_factor));</span>
 <span class="c1">#   DSout[&#39;ZCX&#39;].scale_factor = np.float32(scale_factor);</span>
 <span class="c1">#   DSout[&#39;ZCX&#39;].add_offset = np.float32(add_offset);</span>
 <span class="c1">#   DSout[&#39;ZCX&#39;][:] = packed_data;</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;ZCX&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ZCX</span><span class="p">;</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ZED</span><span class="p">);</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">real</span><span class="p">;</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">imag</span><span class="p">;</span>

<span class="c1">#    add_offset = np.min(I[:]);</span>
<span class="c1">#    scale_factor = (np.max(I[:])-np.min(I[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((I[:,:,:] - add_offset)/scale_factor));</span>
<span class="c1">#    DSout[&#39;I&#39;].scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    DSout[&#39;I&#39;].add_offset = np.float32(add_offset);</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">I</span><span class="p">;</span>

<span class="c1">#    add_offset = np.min(Q[:]);</span>
<span class="c1">#    scale_factor = (np.max(Q[:])-np.min(Q[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((Q[:,:,:] - add_offset)/scale_factor));</span>
<span class="c1">#    DSout[&#39;Q&#39;].scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    DSout[&#39;Q&#39;].add_offset = np.float32(add_offset);</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">Q</span>

    <span class="n">blind_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">][:,:,</span><span class="n">blind_range</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">range_m</span><span class="p">;</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">range_offset_applied</span> <span class="o">+=</span> <span class="n">range_offset</span><span class="p">;</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;range_offset_applied includes offset applied by the data acquisition program&quot;</span><span class="p">;</span>

    <span class="c1"># -----------------------</span>
    <span class="c1"># Update history metadata</span>
    <span class="c1"># -----------------------</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py convert_camra_ts_l0b2l1&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DSin</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DSin</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="convert_copernicus_ts_l0a2l1"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.convert_copernicus_ts_l0a2l1">[docs]</a><span class="k">def</span> <span class="nf">convert_copernicus_ts_l0a2l1</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">outfile</span><span class="p">,</span><span class="n">dBZ_offset</span><span class="p">,</span><span class="n">range_offset</span><span class="p">,</span><span class="n">data_version</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine converts raw (Level 0a) time series data from the Chilbolton 35GHz Cloud Radar (Copernicus) to Level 1 data.</span>
<span class="sd">    Processing involves removing redundant dimensions, and removing bias from the ADC samples of the received I and Q.</span>
<span class="sd">    Metadata are added specific to the WIVERN-2 project ground-based observations collected in 2020-2021.</span>

<span class="sd">    :param infile: Full path of binary Level 0a raw data file, e.g. `&lt;path-to-file&gt;/2021061813445611_iqdata.bin`</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param outfile: Full path of NetCDF Level 0b output file, e.g. `&lt;path-to-file&gt;/ncas-radar-ka-band-1_cao_20210618-134456_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type outfile: str</span>

<span class="sd">    :param dBZ_offset: dB calibration offset to apply to reflectivity.  This is converted to linear units and I and Q values are multiplied by the square root of this value.</span>
<span class="sd">    :type dBZ_offset: float</span>

<span class="sd">    :param range_offset: Range offset to apply in m.</span>
<span class="sd">    :type range_offset: float</span>

<span class="sd">    :param data_version: Version of data product in the format `N.m`, where `N` denotes the major verion and `m` a minor revision</span>
<span class="sd">    :type data_version: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -------------------------------</span>
    <span class="c1"># Read binary IQ time-series file</span>
    <span class="c1"># -------------------------------</span>
    <span class="n">header_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;ngates&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">),(</span><span class="s1">&#39;npulses&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">)]);</span>
    <span class="n">time_dt</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;i4&#39;</span><span class="p">),(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">),(</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">),(</span><span class="s1">&#39;minute&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">),(</span><span class="s1">&#39;second&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">),(</span><span class="s1">&#39;centisecond&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;i4&#39;</span><span class="p">)]);</span>

    <span class="n">A</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">header_dt</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">ngate</span>     <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="s1">&#39;ngates&#39;</span><span class="p">];</span>
    <span class="n">npulse</span>    <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="s1">&#39;npulses&#39;</span><span class="p">];</span>
    <span class="n">iq_dt</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;IQ&#39;</span><span class="p">,</span><span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">)&lt;i2&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npulse</span><span class="p">,</span><span class="n">ngate</span><span class="p">))]);</span>
    <span class="n">record_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">time_dt</span><span class="p">),(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="n">iq_dt</span><span class="p">),(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="n">iq_dt</span><span class="p">)]);</span>

    <span class="n">records</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">record_dt</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">datetime</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;minute&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;second&#39;</span><span class="p">],</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;centisecond&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">10000</span><span class="p">)</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">records</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]);</span>
    <span class="n">nray</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">);</span>

    <span class="n">dt_start</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">dt_end</span>   <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">time_units_out</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_start</span><span class="p">,</span><span class="s1">&#39;seconds since %Y-%m-</span><span class="si">%d</span><span class="s1"> 00:00:00Z&#39;</span><span class="p">);</span>

    <span class="c1"># -----------------------------</span>
    <span class="c1"># Set up NetCDF file for output</span>
    <span class="c1"># -----------------------------</span>
    <span class="n">DSout</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="c1"># ------------------------</span>
    <span class="c1"># Set up global attributes</span>
    <span class="c1"># ------------------------</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">product_version</span> <span class="o">=</span> <span class="s2">&quot;v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_version</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_level</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">licence</span> <span class="o">=</span> <span class="s2">&quot;This dataset is released for use under a Creative Commons Attribution 4.0 International (CC-BY 4.0) license (see https://creativecommons.org/licenses/by/4.0/ for terms and conditions).&quot;</span>
<span class="c1">#    DSout.licence = &quot;Data usage licence - UK Open Government Licence agreement: \n http://www.nationalarchives.gov.uk/doc/open-government-licence&quot; ;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">acknowledgement</span> <span class="o">=</span> <span class="s2">&quot;This dataset was developed as part of the activity </span><span class="se">\&quot;</span><span class="s2">Doppler Wind Radar Science Performance Study (WIVERN-2)</span><span class="se">\&quot;</span><span class="s2">, funded by the European Space Agency under Contract no. 4000130864/20/NL/CT.  Users should acknowledge UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science).&quot;</span> <span class="p">;</span>
<span class="c1">#    DSout.acknowledgement = &quot;Acknowledgement is required of UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science) whenever and wherever these data are used.&quot; ;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;Chilbolton Atmospheric Observatory&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">platform_type</span> <span class="o">=</span> <span class="s2">&quot;stationary_platform&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Time series from 35 GHz Copernicus radar collected for ESA WIVERN-2 campaign at Chilbolton Observatory&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_name</span> <span class="o">=</span> <span class="s2">&quot;Chris Walden&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_email</span> <span class="o">=</span> <span class="s2">&quot;chris.walden@ncas.ac.uk&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_url</span> <span class="o">=</span> <span class="s2">&quot;https://orcid.org/0000-0002-5718-466X&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">institution</span> <span class="o">=</span> <span class="s2">&quot;National Centre for Atmospheric Science (NCAS)&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_name</span> <span class="o">=</span> <span class="s2">&quot;ncas-radar-ka-band-1&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_software</span> <span class="o">=</span> <span class="s2">&quot;radar-copernicus-iq-rec&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_software_version</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">references</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;35GHz Copernicus Radar&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="s2">&quot;WIVERN-2 Doppler Wind Radar Science Performance Study&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator</span> <span class="o">=</span> <span class="s2">&quot;Anthony Illingworth&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator_email</span> <span class="o">=</span> <span class="s2">&quot;a.j.illingworth@reading.ac.uk&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator_url</span> <span class="o">=</span> <span class="s2">&quot;https://orcid.org/0000-0002-5774-8410&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_software_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/longlostjames/wivern_chilbolton_utils.git&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_software_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">scantype</span> <span class="o">=</span> <span class="s2">&quot;vertical_pointing&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">time_coverage_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_start</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">time_coverage_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_end</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">geospatial_bounds</span> <span class="o">=</span> <span class="s2">&quot;51.1447N -1.4384E&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">pulse_compression</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">ADC_bits_per_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">ADC_channels</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

    <span class="c1"># ----------------</span>
    <span class="c1"># Scalar variables</span>
    <span class="c1"># ----------------</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude of the antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree_north&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">51.1447</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude of the antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree_east&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=-</span><span class="mf">1.4384</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;altitude&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude of the antenna above the geoid (WGS84)&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;altitude_agl&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude of the antenna above ground&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.9</span><span class="p">;</span>

    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;altitude&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="mf">130.7</span> <span class="o">+</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;altitude_agl&#39;</span><span class="p">][:];</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;radiation_frequency&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;frequency of transmitted radiation&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;GHz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">34.96</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;prf&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pulse repetition frequency&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mi">5000</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;beamwidthH&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;horizontal angular beamwidth&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.25</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;beamwidthV&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;vertical angular beamwidth&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.25</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_diameter&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;antenna diameter&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">2.4</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_focal_length&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;focal length of antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulse_width&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pulse width&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;us&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">0.4</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;transmit_power&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;peak transmitted power&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mi">1500</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;clock&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock input to timer card&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mi">10000000</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;clock_divfactor&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock divide factor&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;delay_clocks&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock cycles before sampling is initiated&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;samples_per_pulse&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of samples per pulse&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ngate</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulses_per_daq_cycle&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of pulses per data acquisition cycle&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulses_per_ray&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of pulses per ray&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">npulse</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;radar_constant&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;radar constant&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;receiver_gain&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;receiver gain&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;cable_losses&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cable losses&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;extra_attenuation&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;extra attenuation&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;dBZ_offset&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;dBZ offset applied&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;When converted to linear units this is included in the linear reflectivity factor.  The square root of the latter is used to scale the I and Q values.&#39;</span><span class="p">;</span>

    <span class="n">lightspeed</span> <span class="o">=</span> <span class="mi">299792458</span><span class="p">;</span> <span class="c1"># m s-1</span>
    <span class="n">pulse_width_s</span> <span class="o">=</span> <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;pulse_width&#39;</span><span class="p">][:]</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">;</span>
    <span class="n">gate_width</span> <span class="o">=</span> <span class="n">lightspeed</span><span class="o">*</span><span class="n">pulse_width_s</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
    <span class="n">range_m</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ngate</span><span class="p">)</span><span class="o">*</span><span class="n">gate_width</span><span class="p">;</span>
    <span class="n">range_m</span> <span class="o">+=</span> <span class="n">range_offset</span><span class="p">;</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># Create dimensions</span>
    <span class="c1"># -----------------</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span> <span class="n">npulse</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="n">ngate</span><span class="p">);</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Coordinate variables</span>
    <span class="c1"># --------------------</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;time at the start of each recorded ray&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">time_units_out</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">nc4</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="n">varout</span><span class="o">.</span><span class="n">units</span><span class="p">);</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;range&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;distance from the antenna to the middle of each range gate&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">range_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">range_offset</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">range_m</span><span class="p">;</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Antenna pointing variables</span>
    <span class="c1"># --------------------------</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;elevation angle of the antenna boresight above the horizon&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">elevation_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;azimuth angle clockwise from grid north of the plane perpendicular to axis of the elevation tilting mechanism&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">azimuth_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>

    <span class="c1"># ---------------</span>
    <span class="c1"># Field variables</span>
    <span class="c1"># ---------------</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;co-polar in-phase video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Scaled to account for calibration for square root of linear reflectivity factor&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;co-polar quadrature video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Scaled to account for calibraton for square root of linear reflectivity factor&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">,</span><span class="s1">&#39;u1&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">is_quality</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">qualified_variables</span> <span class="o">=</span> <span class="s1">&#39;I Q&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Quality control flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">flag_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">flag_meanings</span> <span class="o">=</span> <span class="s1">&#39;not_used good_data probably_good_data bad_data data_in_blind_range no_qc_performed&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="n">Itmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npulse</span><span class="p">,</span><span class="n">ngate</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">];</span>
    <span class="n">Qtmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npulse</span><span class="p">,</span><span class="n">ngate</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">];</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">Itmp</span><span class="p">);</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">Qtmp</span><span class="p">);</span>

    <span class="n">Imean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">Qmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">I</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[:,:,:]</span><span class="o">-</span><span class="n">Imean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>
    <span class="n">Q</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[:,:,:]</span><span class="o">-</span><span class="n">Qmean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>

<span class="c1">#    Zcal=-146.8-1.0+115;</span>

    <span class="n">Zcal</span><span class="o">=</span><span class="n">dBZ_offset</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][:]</span><span class="o">/</span><span class="mi">512</span><span class="p">);</span>

    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;dBZ_offset&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">Zcal</span><span class="p">;</span>

    <span class="n">I</span><span class="o">=</span><span class="n">I</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Zcal</span><span class="o">/</span><span class="mf">10.0</span><span class="p">));</span>
    <span class="n">Q</span><span class="o">=</span><span class="n">Q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Zcal</span><span class="o">/</span><span class="mf">10.0</span><span class="p">));</span>

    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">I</span><span class="p">;</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">;</span>

    <span class="n">blind_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">][:,:,</span><span class="n">blind_range</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1"># -----------------------</span>
    <span class="c1"># Update history metadata</span>
    <span class="c1"># -----------------------</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">();</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">();</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">();</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py convert_copernicus_ts_l0a2l1&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">history</span><span class="p">);</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>

    <span class="k">return</span></div>

<div class="viewcode-block" id="convert_galileo_ts_l0b2l1"><a class="viewcode-back" href="../api.html#wivern_chilbolton_utils.convert_galileo_ts_l0b2l1">[docs]</a><span class="k">def</span> <span class="nf">convert_galileo_ts_l0b2l1</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">outfile</span><span class="p">,</span><span class="n">dBZ_offset</span><span class="p">,</span><span class="n">range_offset</span><span class="p">,</span><span class="n">data_version</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;This routine converts raw (Level 0b) time series data from the Chilbolton 94GHz Cloud Radar (Galileo) to Level 1 data.</span>
<span class="sd">    Level 0b data have been generated from as-recorded Level 0a data by splitting the files along the time dimension and converting to NetCDF4.</span>
<span class="sd">    Processing by this routine involves removing redundant dimensions, and removing bias from the ADC samples of the received I and Q.</span>
<span class="sd">    Metadata are added specific to the WIVERN-2 project ground-based observations collected in 2020-2021.</span>

<span class="sd">    :param infile: Full path of NetCDF Level 0b data file, e.g. `&lt;path-to-file&gt;/radar-galileo_&lt;YYYYddmmHHMMSS&gt;-&lt;YYYYddmmHHMMSS&gt;_fix-ts.nc4`</span>
<span class="sd">    :type infile: str</span>

<span class="sd">    :param outfile: Full path of NetCDF Level 0b output file, e.g. `&lt;path-to-file&gt;/ncas-radar-w-band-1_cao_20201210-212823_fix-ts_l1_v1.0.nc`</span>
<span class="sd">    :type outfile: str</span>

<span class="sd">    :param dBZ_offset: dB calibration offset to apply to reflectivity.  This is converted to linear units and I and Q values are multiplied by the square root of this value.</span>
<span class="sd">    :type dBZoffset: float</span>

<span class="sd">    :param range_offset: Range offset to apply in metres.</span>
<span class="sd">    :type range_offset: float</span>

<span class="sd">    :param data_version: Version of data product in the format `N.m`, where `N` denotes the major verion and `m` a minor revision.</span>
<span class="sd">    :type data_version: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -----------------------------------------------------</span>
    <span class="c1"># Read NetCDF spectra file with embedded IQ time series</span>
    <span class="c1"># -----------------------------------------------------</span>
    <span class="n">DSin</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">infile</span><span class="p">);</span>

    <span class="n">dt_start</span> <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">num2pydate</span><span class="p">(</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
    <span class="n">dt_end</span>   <span class="o">=</span> <span class="n">cftime</span><span class="o">.</span><span class="n">num2pydate</span><span class="p">(</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>

    <span class="c1"># -----------------------------</span>
    <span class="c1"># Set up NetCDF file for output</span>
    <span class="c1"># -----------------------------</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># just to be safe, make sure dataset is not already open.</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    <span class="n">DSout</span> <span class="o">=</span> <span class="n">nc4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="c1"># ------------------------</span>
    <span class="c1"># Set up global attributes</span>
    <span class="c1"># ------------------------</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">product_version</span> <span class="o">=</span> <span class="s2">&quot;v</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_version</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_level</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">licence</span> <span class="o">=</span> <span class="s2">&quot;This dataset is released for use under a Creative Commons Attribution 4.0 International (CC-BY 4.0) license (see https://creativecommons.org/licenses/by/4.0/ for terms and conditions).&quot;</span>
<span class="c1">#    DSout.licence = &quot;Data usage licence - UK Open Government Licence agreement: \n http://www.nationalarchives.gov.uk/doc/open-government-licence&quot; ;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">acknowledgement</span> <span class="o">=</span> <span class="s2">&quot;This dataset was developed as part of the activity </span><span class="se">\&quot;</span><span class="s2">Doppler Wind Radar Science Performance Study (WIVERN-2)</span><span class="se">\&quot;</span><span class="s2">, funded by the European Space Agency under Contract no. 4000130864/20/NL/CT.  Users should acknowledge UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science).&quot;</span> <span class="p">;</span>
<span class="c1">#    DSout.acknowledgement = &quot;Acknowledgement is required of UK Research and Innovation as the data provider (in partnership with the National Centre for Atmospheric Science) whenever and wherever these data are used.&quot; ;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;Chilbolton Atmospheric Observatory&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">platform_type</span> <span class="o">=</span> <span class="s2">&quot;stationary_platform&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Time series from 94 GHz Galileo radar collected for ESA WIVERN-2 campaign at Chilbolton Observatory&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_name</span> <span class="o">=</span> <span class="s2">&quot;Chris Walden&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_email</span> <span class="o">=</span> <span class="s2">&quot;chris.walden@ncas.ac.uk&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">creator_url</span> <span class="o">=</span> <span class="s2">&quot;https://orcid.org/0000-0002-5718-466X&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">institution</span> <span class="o">=</span> <span class="s2">&quot;National Centre for Atmospheric Science (NCAS)&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_name</span> <span class="o">=</span> <span class="s2">&quot;ncas-radar-w-band-1&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_software</span> <span class="o">=</span> <span class="s2">&quot;radar-galileo-rec&quot;</span> <span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">instrument_software_version</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">references</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;94GHz Galileo Radar&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="s2">&quot;WIVERN-2 Doppler Wind Radar Science Performance Study&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator</span> <span class="o">=</span> <span class="s2">&quot;Anthony Illingworth&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator_email</span> <span class="o">=</span> <span class="s2">&quot;a.j.illingworth@reading.ac.uk&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">project_principal_investigator_url</span> <span class="o">=</span> <span class="s2">&quot;https://orcid.org/0000-0002-5774-8410&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_software_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/longlostjames/wivern_chilbolton_utils.git&quot;</span><span class="p">;</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">processing_software_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">scantype</span> <span class="o">=</span> <span class="s2">&quot;vertical_pointing&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">time_coverage_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_start</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">time_coverage_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt_end</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">geospatial_bounds</span> <span class="o">=</span> <span class="s2">&quot;51.1447N -1.4384E&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">pulse_compression</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">ADC_bits_per_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">ADC_channels</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

    <span class="c1"># ----------------</span>
    <span class="c1"># Scalar variables</span>
    <span class="c1"># ----------------</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude of the antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree_north&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">51.1447</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude of the antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree_east&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=-</span><span class="mf">1.4385</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;altitude&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude of the antenna above the geoid (WGS84)&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">131.6</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;altitude_agl&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude of the antenna above ground&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;radiation_frequency&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;frequency of transmitted radiation&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;GHz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="mf">94.008</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;prf&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pulse repetition frequency&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;beamwidthH&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;beamwidthH&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;horizontal angular beamwidth&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;beamwidthV&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;beamwidthV&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;vertical angular beamwidth&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;antenna_diameter&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_diameter&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;antenna diameter&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Refers to diameter of each antenna in bistatic pair.  Separation of antennae is 0.66m.&quot;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;antenna_focal_length&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;focal length of antenna&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.18</span><span class="p">;</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;pulse_period&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulse_width&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pulse width&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;us&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;transmit_power&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;transmit_power&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;peak transmitted power&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;clock&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;clock&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock input to timer card&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Hz&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">varin</span><span class="p">[:];</span>

    <span class="n">clock_divfactor</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;clock&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clock_divfactor</span><span class="p">;</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;clock_divfactor&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock divide factor&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">clock_divfactor</span><span class="p">;</span>

    <span class="n">delay_clocks</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="s1">&#39;delay_clocks&#39;</span><span class="p">);</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;delay_clocks&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;clock cycles before sampling is initiated&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">delay_clocks</span><span class="p">;</span>

    <span class="n">samples_per_pulse</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="s1">&#39;samples_per_pulse&#39;</span><span class="p">);</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;samples_per_pulse&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of samples per pulse&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">samples_per_pulse</span><span class="p">;</span>

    <span class="n">pulses_per_daq_cycle</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="s1">&#39;pulses_per_daq_cycle&#39;</span><span class="p">);</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulses_per_daq_cycle&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of pulses per data acquisition cycle&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pulses_per_daq_cycle</span><span class="p">;</span>

    <span class="n">pulses_per_ray</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">getncattr</span><span class="p">(</span><span class="s1">&#39;pulses_per_ray&#39;</span><span class="p">);</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pulses_per_ray&#39;</span><span class="p">,</span><span class="s1">&#39;i4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;number of pulses per ray&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pulses_per_ray</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;radar_constant&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;radar constant&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;receiver_gain&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;receiver gain&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;cable_losses&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cable losses&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;extra_attenuation&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;extra attenuation&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;dB&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>


    <span class="c1"># ---------------</span>
    <span class="c1"># Copy dimensions</span>
    <span class="c1"># ---------------</span>
    <span class="n">the_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">];</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_dim</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">the_dim</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">fft_bin_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;fft_bin_dim&#39;</span><span class="p">];</span>
    <span class="n">spectra_number_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;spectra_number_dim&#39;</span><span class="p">];</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fft_bin_dim</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra_number_dim</span><span class="p">));</span>

    <span class="n">the_dim</span> <span class="o">=</span> <span class="n">DSin</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">];</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">the_dim</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">the_dim</span><span class="o">.</span><span class="n">isunlimited</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">DSout</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;pulse&#39;</span><span class="p">]);</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Coordinate variables</span>
    <span class="c1"># --------------------</span>
    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;time at the start of each recorded ray&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">varin</span><span class="o">.</span><span class="n">units</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:];</span>

    <span class="n">varin</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">];</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span><span class="n">varin</span><span class="o">.</span><span class="n">datatype</span><span class="p">,(</span><span class="s1">&#39;range&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;distance from the antenna to the middle of each range gate&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">range_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">range_offset</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">varin</span><span class="o">.</span><span class="n">units</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span><span class="o">=</span><span class="n">varin</span><span class="p">[:]</span><span class="o">+</span><span class="n">range_offset</span><span class="o">-</span><span class="n">varin</span><span class="o">.</span><span class="n">range_offset</span><span class="p">;</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Antenna pointing variables</span>
    <span class="c1"># --------------------------</span>
    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;elevation&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;elevation angle above the horizon of the plane containing the transmit and receive antenna boresights&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">elevation_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;azimuth angle clockwise from grid north of the plane in which the antenna boresights are tilted away from zenith&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">azimuth_offset_applied</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Determine bias-corrected I and Q</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># Input Level 0b file has I and Q dependent on the following dimensions (time,spectra,pulses,sample).</span>
    <span class="c1"># We rearrange this into a three-dimensional array dependent on (time,pulse,range);</span>

    <span class="n">Ico_in</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;IPF_HH&#39;</span><span class="p">][:,:,:,:];</span>
    <span class="n">Qco_in</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QPF_HH&#39;</span><span class="p">][:,:,:,:];</span>

    <span class="n">Icx_in</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;IPF_HV&#39;</span><span class="p">][:,:,:,:];</span>
    <span class="n">Qcx_in</span> <span class="o">=</span> <span class="n">DSin</span><span class="p">[</span><span class="s1">&#39;QPF_HV&#39;</span><span class="p">][:,:,:,:];</span>

    <span class="n">nray</span>     <span class="o">=</span> <span class="n">Ico_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">nspectra</span> <span class="o">=</span> <span class="n">Ico_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">npulse</span>   <span class="o">=</span> <span class="n">Ico_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">ngate</span>    <span class="o">=</span> <span class="n">Ico_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

    <span class="n">Ico</span> <span class="o">=</span> <span class="n">Ico_in</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span><span class="n">npulse</span><span class="o">*</span><span class="n">nspectra</span><span class="p">,</span><span class="n">ngate</span><span class="p">);</span>
    <span class="n">Qco</span> <span class="o">=</span> <span class="n">Qco_in</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span><span class="n">npulse</span><span class="o">*</span><span class="n">nspectra</span><span class="p">,</span><span class="n">ngate</span><span class="p">);</span>

    <span class="n">Ico_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Ico</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">Qco_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Qco</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Ico</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">Ico</span><span class="p">[:,:,:]</span><span class="o">-</span><span class="n">Ico_mean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>
    <span class="n">Qco</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">Qco</span><span class="p">[:,:,:]</span><span class="o">-</span><span class="n">Qco_mean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>

    <span class="n">Zcal</span><span class="o">=</span><span class="n">dBZ_offset</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;prf&#39;</span><span class="p">][:]</span><span class="o">/</span><span class="mi">512</span><span class="p">);</span>

    <span class="n">Ico</span><span class="o">=</span><span class="n">Ico</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Zcal</span><span class="o">/</span><span class="mf">10.0</span><span class="p">));</span>
    <span class="n">Qco</span><span class="o">=</span><span class="n">Qco</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Zcal</span><span class="o">/</span><span class="mf">10.0</span><span class="p">));</span>

    <span class="n">Icx</span> <span class="o">=</span> <span class="n">Icx_in</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span><span class="n">npulse</span><span class="o">*</span><span class="n">nspectra</span><span class="p">,</span><span class="n">ngate</span><span class="p">);</span>
    <span class="n">Qcx</span> <span class="o">=</span> <span class="n">Qcx_in</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nray</span><span class="p">,</span><span class="n">npulse</span><span class="o">*</span><span class="n">nspectra</span><span class="p">,</span><span class="n">ngate</span><span class="p">);</span>

    <span class="n">Icx_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Icx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">Qcx_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Qcx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">Icx</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">Icx</span><span class="p">[:,:,:]</span><span class="o">-</span><span class="n">Icx_mean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>
    <span class="n">Qcx</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">Qcx</span><span class="p">[:,:,:]</span><span class="o">-</span><span class="n">Qcx_mean</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:];</span>

    <span class="n">Icx</span><span class="o">=</span><span class="n">Icx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Zcal</span><span class="o">/</span><span class="mf">10.0</span><span class="p">));</span>
    <span class="n">Qcx</span><span class="o">=</span><span class="n">Qcx</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">Zcal</span><span class="o">/</span><span class="mf">10.0</span><span class="p">));</span>

    <span class="c1"># ---------------</span>
    <span class="c1"># Field variables</span>
    <span class="c1"># ---------------</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;co-polar in-phase video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Scaled to account for calibration for square root of linear reflectivity factor&#39;</span><span class="p">;</span>
<span class="c1">#    add_offset = np.min(Ico[:]);</span>
<span class="c1">#    scale_factor = (np.max(Ico[:])-np.min(Ico[:])) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((Ico[:,:,:] - add_offset)/scale_factor));</span>
    <span class="c1">#varout.scale_factor = np.float32(scale_factor);</span>
    <span class="c1">#varout.add_offset = np.float32(add_offset);</span>
    <span class="c1">#varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Ico</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cross-polar quadrature video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Scaled to account for calibration for square root of linear reflectivity factor&#39;</span><span class="p">;</span>
<span class="c1">#    add_offset = np.min(Qco);</span>
<span class="c1">#    scale_factor = (np.max(Qco)-np.min(Qco)) / (2**16-1)</span>
<span class="c1">#    packed_data = np.int16(np.rint((Qco - add_offset)/scale_factor));</span>
    <span class="c1">#varout.scale_factor = np.float32(scale_factor);</span>
    <span class="c1">#varout.add_offset = np.float32(add_offset);</span>
    <span class="c1">#varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Qco</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Icx&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cross-polar in-phase video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Scaled to account for calibration for square root of linear reflectivity factor&#39;</span><span class="p">;</span>
<span class="c1">#    add_offset = np.min(Icx);</span>
<span class="c1">#    scale_factor = (np.max(Icx)-np.min(Icx)) / (2**16-1);</span>
<span class="c1">#    packed_data = np.int16(np.rint((Icx - add_offset)/scale_factor));</span>
<span class="c1">#    varout.scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    varout.add_offset = np.float32(add_offset);</span>
<span class="c1">#    varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Icx</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Qcx&#39;</span><span class="p">,</span><span class="s1">&#39;f4&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">ancillary_variables</span> <span class="o">=</span> <span class="s1">&#39;qc_flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;cross-polar quadrature video signal&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;Scaled to account for calibration for square root of linear reflectivity factor&#39;</span><span class="p">;</span>
<span class="c1">#    add_offset = np.min(Qcx);</span>
<span class="c1">#    scale_factor = (np.max(Qcx)-np.min(Qcx)) / (2**16-1);</span>
<span class="c1">#    packed_data = np.int16(np.rint((Qcx - add_offset)/scale_factor));</span>
<span class="c1">#    varout.scale_factor = np.float32(scale_factor);</span>
<span class="c1">#    varout.add_offset = np.float32(add_offset);</span>
<span class="c1">#    varout[:] = packed_data;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Qcx</span><span class="p">;</span>

    <span class="n">varout</span> <span class="o">=</span> <span class="n">DSout</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">,</span><span class="s1">&#39;u1&#39;</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;pulse&#39;</span><span class="p">,</span><span class="s1">&#39;range&#39;</span><span class="p">));</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">is_quality</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">qualified_variables</span> <span class="o">=</span> <span class="s1">&#39;I Q Icx Qcx&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Quality control flag&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">flag_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">varout</span><span class="o">.</span><span class="n">flag_meanings</span> <span class="o">=</span> <span class="s1">&#39;not_used good_data probably_good_data bad_data data_in_blind_range no_qc_performed&#39;</span><span class="p">;</span>
    <span class="n">varout</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

    <span class="n">blind_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
    <span class="n">DSout</span><span class="p">[</span><span class="s1">&#39;qc_flag&#39;</span><span class="p">][:,:,</span><span class="n">blind_range</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

    <span class="c1"># -----------------------</span>
    <span class="c1"># Update history metadata</span>
    <span class="c1"># -----------------------</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>

    <span class="n">updttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">updttimestr</span> <span class="o">=</span> <span class="n">updttime</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">updttimestr</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; - user:&quot;</span> <span class="o">+</span> <span class="n">user</span>
    <span class="o">+</span> <span class="s2">&quot; machine: &quot;</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="o">+</span> <span class="s2">&quot; program: wivern_chilbolton_utils.py convert_galileo_ts_l0b2l1&quot;</span>
    <span class="o">+</span> <span class="s2">&quot; version:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_version</span><span class="p">));</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">DSin</span><span class="o">.</span><span class="n">history</span><span class="p">;</span>

    <span class="n">DSout</span><span class="o">.</span><span class="n">last_revised_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">updttime</span><span class="p">,</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%SZ&#39;</span><span class="p">)</span>

    <span class="n">DSin</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">DSout</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>

    <span class="k">return</span></div>

<span class="k">def</span> <span class="nf">process_wivern2_camra_ts</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span><span class="n">inpath</span><span class="p">,</span><span class="n">outpath</span><span class="p">):</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;*</span><span class="si">{}</span><span class="s1">*_fix-ts.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datestr</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">datestr</span><span class="p">);</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">inpath</span><span class="p">);</span>
    <span class="n">datepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inpath</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>

    <span class="n">tsfiles</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="n">tsdirs</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span><span class="n">dirs</span><span class="p">,</span><span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">datepath</span><span class="p">):</span>
        <span class="n">tsfiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)];</span>
        <span class="n">tsdirs</span> <span class="o">+=</span> <span class="n">dirs</span><span class="p">;</span>

    <span class="n">data_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>

    <span class="n">dBZ_offset</span> <span class="o">=</span> <span class="mf">9.0</span><span class="p">;</span>
    <span class="n">ZDR_offset</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">;</span>
    <span class="n">range_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">865.56</span><span class="o">+</span><span class="mf">864.0</span><span class="p">;</span>

    <span class="n">l0bpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L0b&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>
    <span class="n">l1path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">l0bpath</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">l1path</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">tsdirs</span><span class="p">);</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">tsdirs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am Here!&quot;</span><span class="p">);</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l0bpath</span><span class="p">,</span><span class="nb">dir</span><span class="p">),</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l1path</span><span class="p">,</span><span class="nb">dir</span><span class="p">),</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tsfiles</span><span class="p">:</span>
        <span class="n">outfile_splits</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

        <span class="n">outfile_string</span> <span class="o">=</span> <span class="n">outfile_splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;_l0b.nc&#39;</span><span class="p">);</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">outfile_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>
        <span class="n">instrument_name</span> <span class="o">=</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;radar-camra&#39;</span><span class="p">,</span><span class="s1">&#39;ncas-radar-camra-1&#39;</span><span class="p">);</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s1">&#39;cao&#39;</span><span class="p">;</span>
        <span class="n">datestr</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">];</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">8</span><span class="p">:];</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">l0bfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_v</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument_name</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">timestr</span><span class="p">,</span><span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">level</span><span class="p">,</span><span class="n">data_version</span><span class="p">)</span>

        <span class="n">l0bfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;radar-camra&#39;</span><span class="p">,</span><span class="s1">&#39;ncas-radar-camra-1_cao&#39;</span><span class="p">);</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">outfile_splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">tsdirs</span><span class="p">:</span>
            <span class="n">l0bfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L0b&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">l0bfile</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l0bfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L0b&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">l0bfile</span><span class="p">);</span>

        <span class="n">convert_camra_ts_l0a2l0b</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">l0bfile</span><span class="p">);</span>

        <span class="n">l1file</span> <span class="o">=</span> <span class="n">l0bfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;l0b&#39;</span><span class="p">,</span><span class="s1">&#39;l1&#39;</span><span class="p">);</span>
        <span class="n">l1file</span> <span class="o">=</span> <span class="n">l1file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;L0b&#39;</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">);</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">l0bfile</span><span class="p">);</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">l1file</span><span class="p">);</span>

        <span class="n">convert_camra_ts_l0b2l1</span><span class="p">(</span><span class="n">l0bfile</span><span class="p">,</span><span class="n">l1file</span><span class="p">,</span><span class="n">dBZ_offset</span><span class="p">,</span><span class="n">ZDR_offset</span><span class="p">,</span><span class="n">range_offset</span><span class="p">,</span><span class="n">data_version</span><span class="p">);</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">process_wivern2_copernicus_ts</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span><span class="n">inpath</span><span class="p">,</span><span class="n">outpath</span><span class="p">):</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">*_iqdata.bin&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datestr</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">datestr</span><span class="p">);</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">inpath</span><span class="p">);</span>
    <span class="n">datepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inpath</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>

    <span class="n">tsfiles</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="n">tsdirs</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span><span class="n">dirs</span><span class="p">,</span><span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">datepath</span><span class="p">):</span>
        <span class="n">tsfiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)];</span>
        <span class="n">tsdirs</span> <span class="o">+=</span> <span class="n">dirs</span><span class="p">;</span>

    <span class="n">data_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>

    <span class="n">dBZ_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">147.8</span><span class="o">+</span><span class="mi">115</span><span class="p">;</span>
    <span class="n">range_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">645.0</span><span class="p">;</span>

    <span class="n">l1path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">l1path</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">tsdirs</span><span class="p">);</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">tsdirs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am Here!&quot;</span><span class="p">);</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l1path</span><span class="p">,</span><span class="nb">dir</span><span class="p">),</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tsfiles</span><span class="p">:</span>
        <span class="n">outfile_splits</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

        <span class="n">outfile_string</span> <span class="o">=</span> <span class="n">outfile_splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;iqdata.bin&#39;</span><span class="p">,</span><span class="s1">&#39;fix-ts_l1.nc&#39;</span><span class="p">);</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">outfile_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>
        <span class="n">instrument_name</span> <span class="o">=</span><span class="s1">&#39;ncas-radar-ka-band-1&#39;</span><span class="p">;</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s1">&#39;cao&#39;</span><span class="p">;</span>
        <span class="n">datestr</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">];</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">:];</span>
        <span class="n">scantype</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">l1file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_v</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument_name</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">timestr</span><span class="p">,</span><span class="n">scantype</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">data_version</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">outfile_splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">tsdirs</span><span class="p">:</span>
            <span class="n">l1file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">l1file</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l1file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">l1file</span><span class="p">);</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">l1file</span><span class="p">);</span>

        <span class="n">convert_copernicus_ts_l0a2l1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">l1file</span><span class="p">,</span><span class="n">dBZ_offset</span><span class="p">,</span><span class="n">range_offset</span><span class="p">,</span><span class="n">data_version</span><span class="p">);</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">process_wivern2_galileo_ts</span><span class="p">(</span><span class="n">datestr</span><span class="p">,</span><span class="n">inpath</span><span class="p">,</span><span class="n">outpath</span><span class="p">):</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;*</span><span class="si">{}</span><span class="s1">*_fix-fft-raw.nc4&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datestr</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">datestr</span><span class="p">);</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">inpath</span><span class="p">);</span>
    <span class="n">datepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inpath</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>

    <span class="n">tsfiles</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="n">tsdirs</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span><span class="n">dirs</span><span class="p">,</span><span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">datepath</span><span class="p">):</span>
        <span class="n">tsfiles</span> <span class="o">+=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)];</span>
        <span class="n">tsdirs</span> <span class="o">+=</span> <span class="n">dirs</span><span class="p">;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">tsfiles</span><span class="p">);</span>

    <span class="n">data_version</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span><span class="p">;</span>

    <span class="n">dBZ_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">167.0</span><span class="o">+</span><span class="mf">111.5</span><span class="p">;</span>
    <span class="n">range_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mf">330.0</span><span class="p">;</span>

    <span class="n">l1path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">);</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">l1path</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">tsdirs</span><span class="p">);</span>
    <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">tsdirs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I am Here!&quot;</span><span class="p">);</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l1path</span><span class="p">,</span><span class="nb">dir</span><span class="p">),</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tsfiles</span><span class="p">:</span>
        <span class="n">outfile_splits</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

        <span class="n">outfile_string</span> <span class="o">=</span> <span class="n">outfile_splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nc4&#39;</span><span class="p">,</span><span class="s1">&#39;_l1.nc&#39;</span><span class="p">);</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">outfile_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>
        <span class="n">instrument_name</span> <span class="o">=</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;radar-galileo&#39;</span><span class="p">,</span><span class="s1">&#39;ncas-radar-w-band-1&#39;</span><span class="p">);</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s1">&#39;cao&#39;</span><span class="p">;</span>
        <span class="n">datestr0</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">datestr</span> <span class="o">=</span> <span class="n">datestr0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">];</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">datestr0</span><span class="p">[</span><span class="mi">8</span><span class="p">:];</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">l1file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_v</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument_name</span><span class="p">,</span><span class="n">platform</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">timestr</span><span class="p">,</span><span class="s1">&#39;fix-ts&#39;</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">data_version</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">outfile_splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">tsdirs</span><span class="p">:</span>
            <span class="n">l1file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">l1file</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l1file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="n">datestr</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">l1file</span><span class="p">);</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">l1file</span><span class="p">);</span>

        <span class="n">convert_galileo_ts_l0b2l1</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">l1file</span><span class="p">,</span><span class="n">dBZ_offset</span><span class="p">,</span><span class="n">range_offset</span><span class="p">,</span><span class="n">data_version</span><span class="p">);</span>

    <span class="k">return</span>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, UK Research and Innovation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>